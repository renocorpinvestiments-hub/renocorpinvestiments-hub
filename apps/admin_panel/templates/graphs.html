{% load static %}
{% block title %}Graphs & Analytics | Renocorp Admin{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Dashboard | Renocorp Admin</title>

  <style>
    body {
      background-color: #0d1117;
      color: #e6edf3;
      font-family: "Inter", sans-serif;
      margin: 0;
      padding-bottom: 70px;
    }

    .container {
      max-width: 1000px;
      margin: 1.5rem auto;
      padding: 1.5rem;
    }

    h2 {
      color: #58a6ff;
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 1.2rem;
    }

    .chart-card {
      background-color: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .chart-card h3 {
      color: #58a6ff;
      border-bottom: 1px solid #30363d;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    select {
      background: #0d1117;
      color: #e6edf3;
      border: 1px solid #30363d;
      padding: 5px 8px;
      border-radius: 6px;
      font-size: 0.85rem;
    }

    canvas {
      width: 100% !important;
      height: 350px !important;
    }

    /* ===== Bottom Navigation ===== */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #161b22;
      border-top: 1px solid #30363d;
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
    }

    .bottom-nav a {
      flex: 0 0 auto;
      padding: 0.6rem 1rem;
      color: #8b949e;
      text-decoration: none;
      font-size: 0.85rem;
      text-align: center;
    }

    .bottom-nav a.active {
      color: #58a6ff;
      font-weight: 600;
    }

    .bottom-nav i {
      font-size: 1.2rem;
      display: block;
      margin-bottom: 0.2rem;
      }
  </style>
</head>

<body>
<div class="container">
  <h2>Analytics Dashboard</h2>

  <!-- USER GROWTH -->
  <div class="chart-card">
    <h3>
      User Growth
      <select id="growthRange">
        <option value="day">Today</option>
        <option value="week" selected>7 Days</option>
        <option value="month">30 Days</option>
        <option value="year">1 Year</option>
      </select>
    </h3>
    <canvas id="userGrowthChart"></canvas>
  </div>

  <!-- REFERRAL RATE -->
  <div class="chart-card">
    <h3>Referral Rate (Invites per Hour)</h3>
    <canvas id="referralChart"></canvas>
  </div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <a href="{% url 'admin_panel:dashboard' %}">
    <i class="bi bi-people"></i>Users
  </a>
  <a href="{% url 'admin_panel:graphs' %}">
    <i class="bi bi-graph-up"></i>Graphs
  </a>
  <a href="{% url 'admin_panel:manual_login' %}" class="active">
    <i class="bi bi-person-plus"></i>Login
  </a>
  <a href="{% url 'admin_panel:gift_upload' %}">
    <i class="bi bi-gift"></i>Gifts
  </a>
  <a href="{% url 'admin_panel:settings' %}">
    <i class="bi bi-gear"></i>Settings
  </a>
  <a href="{% url 'admin_panel:transactions' %}">
    <i class="bi bi-cash-stack"></i>Trans
  </a>
</nav>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const colors = { blue: '#58a6ff', green: '#2ea043' };

let userGrowthChart, referralChart;

// INIT
document.addEventListener("DOMContentLoaded", () => {
  initCharts();
  startLiveUpdates();

  document.getElementById("growthRange").addEventListener("change", () => {
    fetchAndUpdate();
  });
});

// CREATE CHARTS
function initCharts() {
  userGrowthChart = new Chart(document.getElementById("userGrowthChart"), {
    type: 'line',
    data: { labels: [], datasets: [{
      label: 'New Users',
      data: [],
      borderColor: colors.blue,
      tension: 0.3,
      fill: false
    }]},
    options: chartOptions()
  });

  referralChart = new Chart(document.getElementById("referralChart"), {
    type: 'line',
    data: { labels: [], datasets: [{
      label: 'Invites / Hour',
      data: [],
      borderColor: colors.green,
      tension: 0.3,
      fill: false
    }]},
    options: chartOptions()
  });

  fetchAndUpdate();
}

// FETCH DATA (LIVE)
function fetchAndUpdate() {
  const range = document.getElementById("growthRange").value;
  fetch(`?range=${range}`, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
  .then(res => res.text())
  .then(html => {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    const growthData = JSON.parse(doc.querySelector("#growth-data").textContent);
    const referralData = JSON.parse(doc.querySelector("#referral-data").textContent);

    updateChart(userGrowthChart, growthData);
    updateChart(referralChart, referralData);
  });
}

// UPDATE CHART
function updateChart(chart, data) {
  chart.data.labels = data.labels;
  chart.data.datasets[0].data = data.values;
  chart.update();
}

// AUTO REFRESH EVERY 10s
function startLiveUpdates() {
  setInterval(fetchAndUpdate, 10000);
}

function chartOptions() {
  return {
    responsive: true,
    plugins: {
      legend: { labels: { color: '#e6edf3' } }
    },
    scales: {
      x: { ticks: { color: '#8b949e' } },
      y: { ticks: { color: '#8b949e' }, beginAtZero: true }
    }
  };
}
</script>

<!-- HIDDEN JSON PAYLOADS -->
<script type="application/json" id="growth-data">
  {{ user_growth_data|safe }}
</script>

<script type="application/json" id="referral-data">
  {{ referral_data|safe }}
</script>

</body>
</html>
{% endblock %}
