{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Renocorp Tasks — Dark</title>
<link rel="stylesheet" href="{% static 'css/inter.css' %}">
<style>
  :root{
    --bg:#0b0f13; --card:#0f161b; --muted:#9aa6b2; --accent:#1db954;
    --glass: rgba(255,255,255,0.03); --outline: rgba(255,255,255,0.06);
    --danger: #ff6b6b; --white: #e6eef3;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--white); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; height:100vh; display:flex; flex-direction:column;}
  .app{padding:14px; padding-bottom:80px; max-width:720px; margin:0 auto; width:100%; flex:1 1 auto;}
  .header{display:flex; flex-direction:column; gap:10px; margin-bottom:12px;}
  .title-row{display:flex; justify-content:space-between; align-items:center;}
  .title-row h1{margin:0; font-size:18px; letter-spacing:0.6px;}
  .progress-wrap{background:var(--glass); border-radius:999px; padding:6px; border:1px solid var(--outline); overflow:hidden;}
  .progress{height:10px; width:0%; background:linear-gradient(90deg,var(--accent),#22c1c3); border-radius:999px; transition:width .3s ease;}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:8px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent); border:1px solid var(--outline); border-radius:12px; overflow:hidden; position:relative; min-height:160px; display:flex; flex-direction:column;}
  .thumb{position:relative; height:120px; background:#071018; display:flex; align-items:center; justify-content:center;}
  .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
  .play-circle{position:absolute; width:48px; height:48px; border-radius:50%; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.06); cursor:pointer;}
  .play-triangle{width:0;height:0;border-left:12px solid var(--white); border-top:8px solid transparent;border-bottom:8px solid transparent; margin-left:3px;}
  .card .meta{padding:10px; font-size:13px; color:var(--muted); display:flex; justify-content:space-between; align-items:center; gap:8px; flex-direction:column;}
  .completed-badge{background:rgba(255,255,255,0.06); color:var(--accent); font-weight:600; padding:6px 8px; border-radius:999px; font-size:12px; text-align:center;}
  .player-overlay{position:fixed; inset:0; display:none; background:linear-gradient(180deg, rgba(5,7,8,0.95), rgba(5,7,8,0.98)); z-index:60; justify-content:center; align-items:flex-start; padding:14px;}
  .player-box{width:100%; max-width:720px; background:transparent; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; align-items:stretch;}
  .video-area{position:relative; background:black; border-radius:12px; overflow:hidden; height:calc(100vh - 260px); display:flex; align-items:center; justify-content:center;}
  video{width:100%; height:100%; object-fit:cover; background:black;}
  .video-controls{position:absolute; bottom:12px; left:12px; right:12px; display:flex; justify-content:space-between; align-items:center; gap:8px; pointer-events:none;}
  .mini-info{pointer-events:auto; background:rgba(0,0,0,0.45); padding:8px 10px; border-radius:999px; color:var(--white); font-size:13px;}
  .expand-top{position:absolute; top:12px; left:12px; pointer-events:auto;}
  .desc-area{margin-top:8px; background:var(--card); border-radius:12px; padding:10px; border:1px solid var(--outline); color:var(--muted); font-size:14px;}
  .desc-row{display:flex; justify-content:space-between; align-items:center; gap:8px;}
  .like-row{margin-top:10px;}
  .like-button{padding:10px 12px; border-radius:10px; background:var(--accent); color:#02120a; border:none; font-weight:700; cursor:pointer; width:100%;}
  .navbar{position:fixed; bottom:0; left:0; right:0; height:62px; display:flex; justify-content:space-around; align-items:center; background:linear-gradient(180deg, rgba(7,10,12,0.98), rgba(7,10,12,0.96)); border-top:1px solid rgba(255,255,255,0.03); z-index:70;}
  .nav-item{color:var(--muted); text-decoration:none; font-size:14px; text-align:center;}
  .nav-item.active{color:var(--white); font-weight:700;}
  @media (min-width:700px){.grid { grid-template-columns:repeat(3,1fr); } .thumb { height:140px; }}
  .swipe-hint{position:absolute; bottom:26px; left:50%; transform:translateX(-50%); display:flex; flex-direction:column; gap:6px; align-items:center; opacity:0.9; pointer-events:none;}
  .swipe-hint span{width:22px;height:6px;border-radius:6px; background:rgba(255,255,255,0.06); display:block;}
  .thumb .overlay-completed{position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.5); color:var(--accent); padding:6px 8px; border-radius:8px; font-size:12px; border:1px solid rgba(255,255,255,0.04);}
  .card{ cursor:pointer; }
  .card:active{ transform:scale(0.98); }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="title-row">
      <h1>RENOCORP TASKS</h1>
      <div style="color:var(--muted);font-size:13px">Tasks</div>
    </div>
    <div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Task completion</div>
      <div class="progress-wrap" aria-hidden="true">
        <div class="progress" id="progressBar" style="width:{{ progress }}%"></div>
      </div>
    </div>
  </div>

  <div class="grid" id="grid">
    {# --- Video Tasks --- #}
    {% for video in videos %}
      <div class="card" data-id="{{ video.id }}">
        <div class="thumb">
          {% if video.thumbnail %}
            <img src="{{ video.thumbnail }}" alt="{{ video.title }}">
          {% endif %}
          <div class="play-circle"><div class="play-triangle"></div></div>
          {% if video.id in completed_ids.video %}<div class="overlay-completed">Completed</div>{% endif %}
        </div>
        <div class="meta">
          <div>{{ video.title }}</div>
          <div>{{ video.description|default:"No description" }}</div>
          <div class="completed-badge">
  {% if video.id in completed_ids.video %}
    Completed
  {% else %}
    Active
  {% endif %}
          </div>
          <div style="font-size:12px;color:var(--muted)">Video</div>
        </div>
      </div>
    {% endfor %}

    {# --- Survey Tasks --- #}
    {% for survey in surveys %}
      {% if survey.provider_url or survey.iframe_url %}
      <div class="card task-card"
     data-url="{{ survey.provider_url|default:survey.iframe_url }}">
        <div class="thumb"></div>
        <div class="meta">
          <div>{{ survey.title }}</div>
          <div>{{ survey.description|default:"No description" }}</div>
          <div class="completed-badge">
  {% if survey.id in completed_ids.survey %}
    Completed
  {% else %}
    Active
  {% endif %}
          </div>
          <div style="font-size:12px;color:var(--muted)">Survey</div>
        </div>
      </div>
      {% endif %}
    {% endfor %}

    {# --- App Install Tasks --- #}
    {% for app in app_test %}
      <div class="card task-card"
     data-url="{{ app.download_url }}">
        <div class="thumb"></div>
        <div class="meta">
          <div>{{ app.name }}</div>
          <div>{{ app.description|default:"No description" }}</div>
          <div class="completed-badge">
  {% if app.id in completed_ids.app %}
    Completed
  {% else %}
    Active
  {% endif %}
          </div>
          <div style="font-size:12px;color:var(--muted)">App Install</div>
          
        </div>
      </div>
    {% endfor %}

    {# --- Multi-task Iframe Offerwalls --- #}
    {% for iframe_task in iframe_tasks %}
      {% if iframe_task.iframe_url %}
      <div class="card task-card"
     data-url="{{ iframe_task.iframe_url }}">
        <div class="thumb"></div>
        <div class="meta">
          <div>{{ iframe_task.title }}</div>
          <div>{{ iframe_task.description|default:"Multiple tasks inside, click" }}</div>
          <div class="completed-badge">{{ "Active" }}</div>
          <div style="font-size:12px;color:var(--muted)">Offerwall</div>
          
        </div>
      </div>
      {% endif %}
    {% endfor %}
  </div>

  {% if not videos and not surveys and not app_test and not iframe_tasks %}
  <div style="color:var(--muted); font-size:14px; text-align:center; padding:20px;">
    No tasks available, please wait...
  </div>
  {% endif %}
</div>

<div class="player-overlay" id="playerOverlay" aria-hidden="true">
  <div class="player-box" role="dialog" aria-label="Video player">
    <div class="video-area" id="videoArea">
      <video id="player" playsinline webkit-playsinline preload="auto"></video>
      <div class="expand-top">
        <button id="closePlayer" style="background:transparent;border:none;color:var(--white);padding:8px;font-size:18px;cursor:pointer">←</button>
      </div>
      <div class="video-controls">
        <div class="mini-info" id="miniInfo">00:00 / 00:00</div>
        <div class="mini-info" id="watchState">Playing...</div>
      </div>
      <div class="swipe-hint" aria-hidden="true"><span></span><span></span><span></span></div>
    </div>
    <div class="desc-area">
      <div class="desc-row">
        <div id="videoTitle" style="font-weight:700;color:var(--white)">Video title</div>
        <div id="videoCompleteBadge" class="completed-badge" style="display:none">COMPLETED</div>
      </div>
      <div style="margin-top:8px;color:var(--muted)" id="videoDesc">Video description</div>
      <div class="like-row"><button id="likeButton" class="like-button">Like</button></div>
    </div>
  </div>
</div>

<!-- NAVIGATION -->
<div class="navbar">
  <a class="nav-item" href="{% url 'dashboard:home' %}">Home</a>
  <a class="nav-item active" href="{% url 'dashboard:tasks' %} active ">Tasks</a>
  <a class="nav-item" href="{% url 'dashboard:gifts' %}">Gifts</a>
  <a class="nav-item" href="{% url 'dashboard:account' %}">Account</a>
</div>

<script>
  const completed_ids = {
    video: {{ completed_ids.video|safe }},
    survey: {{ completed_ids.survey|safe }},
    app: {{ completed_ids.app|safe }}
  };

  document.addEventListener("DOMContentLoaded", () => {
    const playerOverlay = document.getElementById("playerOverlay");
    const player = document.getElementById("player");
    const closePlayer = document.getElementById("closePlayer");
    const videoTitle = document.getElementById("videoTitle");
    const videoDesc = document.getElementById("videoDesc");
    const videoCompleteBadge = document.getElementById("videoCompleteBadge");
    const likeButton = document.getElementById("likeButton");
    const miniInfo = document.getElementById("miniInfo");
    const watchState = document.getElementById("watchState");

    if (window.videos) {
      document.querySelectorAll(".card").forEach(card => {
        document.querySelectorAll(".card[data-id]").forEach(card => {
          const videoId = card.dataset.id;
          const videoData = window.videos.find(v => v.id == videoId);
          if (!videoData) return;
          player.src = videoData.video_url;
          videoTitle.textContent = videoData.title;
          videoDesc.textContent = videoData.description;
          videoCompleteBadge.style.display = completed_ids.video.includes(videoId) ? "block" : "none";
          watchState.textContent = "Playing...";
          miniInfo.textContent = "00:00 / 00:00";
          playerOverlay.style.display = "flex";
          player.play();
        });
      });
    }

    closePlayer.addEventListener("click", () => {
      player.pause();
      playerOverlay.style.display = "none";
      player.src = "";
    });

    player.addEventListener("timeupdate", () => {
      const cur = Math.floor(player.currentTime);
      const dur = Math.floor(player.duration);
      miniInfo.textContent = `${formatTime(cur)} / ${formatTime(dur)}`;
    });

    player.addEventListener("ended", () => {
      watchState.textContent = "Completed";
      videoCompleteBadge.style.display = "block";
      updateProgress();
    });

    function formatTime(sec) {
      const m = Math.floor(sec / 60).toString().padStart(2, "0");
      const s = (sec % 60).toString().padStart(2, "0");
      return `${m}:${s}`;
    }

    likeButton.addEventListener("click", () => {
      likeButton.disabled = true;
      likeButton.textContent = "Liked!";
    });

    function updateProgress() {
      const totalTasks = document.querySelectorAll(".card").length;
      const completedTasks = document.querySelectorAll(".overlay-completed, .completed-badge").length;
      const progress = totalTasks ? Math.floor((completedTasks / totalTasks) * 100) : 0;
      document.getElementById("progressBar").style.width = progress + "%";
    }

    updateProgress();
  });

document.querySelectorAll(".task-card").forEach(card => {
  card.addEventListener("click", () => {
    const url = card.dataset.url;
    if (url) {
      window.open(url, "_blank");
    }
  });
});
  </script>
</body>
</html>
